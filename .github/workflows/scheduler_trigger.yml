name: Scheduler Trigger

# This workflow triggers the Lead Sequencer and Email Sender on schedule
# Uses API dispatch to work around GitHub's unreliable native scheduling

on:
  schedule:
    # Run every hour from 8am-9pm UTC to cover all needed times
    - cron: '0 8,9,11,12,13,15,17,18,21 * * *'
  workflow_dispatch:
    inputs:
      target:
        description: 'Which workflow to trigger'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - sequencer
          - email
          - both

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Determine what to trigger
        id: decide
        run: |
          HOUR=$(TZ=Europe/London date +%H)
          DAY=$(TZ=Europe/London date +%u)  # 1=Monday, 7=Sunday

          echo "Current UK hour: $HOUR"
          echo "Current UK day: $DAY (1=Mon, 7=Sun)"

          TARGET="${{ github.event.inputs.target || 'auto' }}"

          if [ "$TARGET" = "auto" ]; then
            # Sequencer runs at 9, 13, 18, 21 UK time (every day)
            TRIGGER_SEQUENCER="false"
            if [ "$HOUR" = "09" ] || [ "$HOUR" = "13" ] || [ "$HOUR" = "18" ] || [ "$HOUR" = "21" ]; then
              TRIGGER_SEQUENCER="true"
            fi

            # Email runs at 9, 11, 13, 15, 17 UK time (weekdays only)
            TRIGGER_EMAIL="false"
            if [ "$DAY" -ge 1 ] && [ "$DAY" -le 5 ]; then
              if [ "$HOUR" = "09" ] || [ "$HOUR" = "11" ] || [ "$HOUR" = "13" ] || [ "$HOUR" = "15" ] || [ "$HOUR" = "17" ]; then
                TRIGGER_EMAIL="true"
              fi
            fi
          elif [ "$TARGET" = "sequencer" ]; then
            TRIGGER_SEQUENCER="true"
            TRIGGER_EMAIL="false"
          elif [ "$TARGET" = "email" ]; then
            TRIGGER_SEQUENCER="false"
            TRIGGER_EMAIL="true"
          elif [ "$TARGET" = "both" ]; then
            TRIGGER_SEQUENCER="true"
            TRIGGER_EMAIL="true"
          fi

          echo "trigger_sequencer=$TRIGGER_SEQUENCER" >> $GITHUB_OUTPUT
          echo "trigger_email=$TRIGGER_EMAIL" >> $GITHUB_OUTPUT

          echo ""
          echo "Will trigger sequencer: $TRIGGER_SEQUENCER"
          echo "Will trigger email: $TRIGGER_EMAIL"

      - name: Trigger Lead Sequencer
        if: steps.decide.outputs.trigger_sequencer == 'true'
        run: |
          echo "Triggering Lead Sequencer..."
          curl -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.CRON_TRIGGER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"ref":"main","inputs":{"skip_time_guard":"true"}}' \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/sequencer.yml/dispatches
          echo "Lead Sequencer triggered!"

      - name: Trigger Email Sender
        if: steps.decide.outputs.trigger_email == 'true'
        run: |
          echo "Triggering Email Sender..."
          curl -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.CRON_TRIGGER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"ref":"main","inputs":{"force_run":"true","dry_run":"false"}}' \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/email_sender.yml/dispatches
          echo "Email Sender triggered!"

      - name: Nothing to trigger
        if: steps.decide.outputs.trigger_sequencer == 'false' && steps.decide.outputs.trigger_email == 'false'
        run: |
          echo "No workflows to trigger at this time."
          echo "This is expected - the scheduler runs hourly but only triggers at specific UK times."
