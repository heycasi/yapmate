name: YapMate Leads Pipeline

# Combined scrape + send workflow
# Runs 4x daily on weekdays at UK-friendly times:
#   - 11:00 UTC (11:00 UK winter / 12:00 UK summer)
#   - 14:00 UTC (14:00 UK winter / 15:00 UK summer)
#   - 16:30 UTC (16:30 UK winter / 17:30 UK summer)
#   - 19:30 UTC (19:30 UK winter / 20:30 UK summer)
# Targets: late morning, afternoon, end-of-day, evening

on:
  schedule:
    - cron: '0 11,14 * * 1-5'    # 11:00 and 14:00 UTC
    - cron: '30 16,19 * * 1-5'   # 16:30 and 19:30 UTC
  workflow_dispatch:

concurrency:
  group: yapmate-leads-pipeline
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'
  # Hardcoded config - cannot be misconfigured
  SEND_LIMIT_PER_RUN: '30'
  DAILY_LIMIT: '150'
  WARMUP_ENABLED: 'false'
  AUTO_APPROVE_ENABLED: 'true'

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: yapmate-leads/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r yapmate-leads/requirements.txt

      - name: Run Pipeline (Scrape + Enrich, multi-iteration)
        id: sequencer
        working-directory: yapmate-leads
        env:
          GOOGLE_SHEETS_CREDENTIALS_JSON: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS_JSON }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_KEY }}
          APIFY_ACTOR_ID: ${{ secrets.APIFY_ACTOR_ID }}
          AUTO_APPROVE_ENABLED: ${{ env.AUTO_APPROVE_ENABLED }}
        run: |
          echo "=========================================="
          echo "STEP 1: PIPELINE (Scrape + Enrich)"
          echo "=========================================="
          echo "Time: $(TZ=Europe/London date '+%Y-%m-%d %H:%M %Z')"
          echo ""

          # Use run_pipeline.py which loops through multiple city+trade
          # combos (up to 8 iterations) until ~30 emails found.
          # Exit code 2 = targets not met (not an error, just low yield).
          python scripts/run_pipeline.py --discovery-only --timeout 2700 || EXIT_CODE=$?
          if [ "${EXIT_CODE:-0}" -eq 1 ]; then
            echo "Pipeline failed with critical error"
            exit 1
          fi

          echo ""
          echo "Pipeline discovery completed"

      - name: Run Email Sender
        id: sender
        working-directory: yapmate-leads
        env:
          GOOGLE_SHEETS_CREDENTIALS_JSON: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS_JSON }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_FROM_NAME: ${{ secrets.EMAIL_FROM_NAME }}
          EMAIL_REPLY_TO: ${{ secrets.EMAIL_REPLY_TO }}
          SEND_ENABLED: ${{ secrets.SEND_ENABLED }}
          DAILY_LIMIT: ${{ env.DAILY_LIMIT }}
          SEND_LIMIT_PER_RUN: ${{ env.SEND_LIMIT_PER_RUN }}
          WARMUP_ENABLED: ${{ env.WARMUP_ENABLED }}
        run: |
          echo ""
          echo "=========================================="
          echo "STEP 2: EMAIL SENDER"
          echo "=========================================="
          echo "Time: $(TZ=Europe/London date '+%Y-%m-%d %H:%M %Z')"
          echo "SEND_ENABLED: ${SEND_ENABLED:-not set}"
          echo "DAILY_LIMIT: ${DAILY_LIMIT}"
          echo "SEND_LIMIT_PER_RUN: ${SEND_LIMIT_PER_RUN}"
          echo ""

          python scripts/run_sequencer.py --send-only

          echo ""
          echo "Email sender completed"

      - name: Pipeline Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "PIPELINE SUMMARY"
          echo "=========================================="
          echo "Sequencer: ${{ steps.sequencer.outcome }}"
          echo "Sender: ${{ steps.sender.outcome }}"
          echo ""
          if [ "${{ steps.sequencer.outcome }}" = "failure" ]; then
            echo "❌ Pipeline failed at sequencer step"
            echo "   Check logs above for: OpenAI quota, Apify errors, or Sheets issues"
          elif [ "${{ steps.sender.outcome }}" = "failure" ]; then
            echo "❌ Pipeline failed at sender step"
            echo "   Check logs above for: SEND_ENABLED, eligible leads, or Resend errors"
          elif [ "${{ steps.sender.outcome }}" = "skipped" ]; then
            echo "⚠️  Sender was skipped (sequencer failed)"
          else
            echo "✅ Pipeline completed successfully"
          fi
          echo "=========================================="
