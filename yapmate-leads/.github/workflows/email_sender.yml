name: Email Sender

# SIMPLE: Runs every 30 min during UK business hours, sends up to 25 emails per run.
# Target: 150 emails/day (6 runs x 25 emails = 150)
#
# Schedule: 09:00, 09:30, 10:00, 13:00, 13:30, 14:00, 17:00, 17:30, 18:00 UK
# That's 9 runs/day x 25 = 225 max capacity, DAILY_LIMIT caps at 150

on:
  schedule:
    # UK business hours - covers both GMT and BST
    # Morning: 09:00-10:30 UK (08:00-10:30 UTC in summer, 09:00-10:30 UTC in winter)
    - cron: '0,30 8,9,10 * * 1-5'
    # Afternoon: 13:00-14:30 UK
    - cron: '0,30 12,13,14 * * 1-5'
    # Evening: 17:00-18:30 UK
    - cron: '0,30 16,17,18 * * 1-5'
  workflow_dispatch:
    inputs:
      send_limit:
        description: 'Max emails to send this run'
        required: false
        type: number
      force_run:
        description: 'Bypass all guards'
        required: false
        type: boolean
        default: false

concurrency:
  group: email-sender
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'

defaults:
  run:
    working-directory: yapmate-leads

jobs:
  send-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check UK business hours
        id: time_check
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime
          import pytz

          uk = pytz.timezone("Europe/London")
          now = datetime.now(uk)
          hour = now.hour
          weekday = now.weekday()  # 0=Mon, 6=Sun

          # Weekdays only, during business windows
          in_hours = (
              weekday < 5 and  # Mon-Fri
              ((9 <= hour < 11) or (13 <= hour < 15) or (17 <= hour < 19))
          )

          print(f"UK time: {now.strftime('%Y-%m-%d %H:%M %Z')} (weekday={weekday})")
          print(f"In business hours: {in_hours}")

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"in_hours={'true' if in_hours else 'false'}\n")
          EOF

      - name: Send emails
        if: steps.time_check.outputs.in_hours == 'true' || github.event.inputs.force_run == 'true'
        env:
          GOOGLE_SHEETS_CREDENTIALS_JSON: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS_JSON }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_FROM_NAME: ${{ secrets.EMAIL_FROM_NAME }}
          EMAIL_REPLY_TO: ${{ secrets.EMAIL_REPLY_TO }}
          SEND_ENABLED: 'true'
          DAILY_LIMIT: '150'
          SEND_LIMIT_PER_RUN: '25'
          WARMUP_ENABLED: 'false'
          DELAY_BETWEEN_SENDS: '0.5'
          FORCE_RUN: ${{ github.event.inputs.force_run == 'true' && 'true' || 'false' }}
        run: |
          echo "=========================================="
          echo "EMAIL SENDER"
          echo "=========================================="
          echo "Time: $(TZ=Europe/London date '+%Y-%m-%d %H:%M %Z')"
          echo "Daily limit: 150"
          echo "Per-run limit: 25"
          echo ""

          ARGS="--send-only"
          if [ -n "${{ github.event.inputs.send_limit }}" ]; then
            ARGS="$ARGS --send-limit ${{ github.event.inputs.send_limit }}"
          fi
          if [ "$FORCE_RUN" = "true" ]; then
            ARGS="$ARGS --force-run"
          fi

          python scripts/run_sequencer.py $ARGS

      - name: Skip notice
        if: steps.time_check.outputs.in_hours != 'true' && github.event.inputs.force_run != 'true'
        run: |
          echo "Skipped - outside UK business hours"
          echo "Hours: 09-11, 13-15, 17-19 UK (Mon-Fri)"
