(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[91,881],{77:function(e,t,a){Promise.resolve().then(a.bind(a,4129))},4129:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return u}});var r=a(7437),n=a(2265),s=a(6463),i=a(6881),o=a(6079),c=a(146),l=a(4407);function u(){let[e,t]=(0,n.useState)("Plumber"),[u,d]=(0,n.useState)(!1),[m,h]=(0,n.useState)(0),[p,f]=(0,n.useState)(null),[x,b]=(0,n.useState)(null),[g,y]=(0,n.useState)(null),[w,v]=(0,n.useState)(null),[j,N]=(0,n.useState)(!1),[S,I]=(0,n.useState)(!1),[C,E]=(0,n.useState)(null),[R,k]=(0,n.useState)(0),[A,T]=(0,n.useState)(!0),[_,O]=(0,n.useState)(null),[P,D]=(0,n.useState)(!0),F=(0,s.useRouter)(),U=(0,n.useRef)(null),M=(0,n.useRef)([]),B=(0,n.useRef)(null),z=(0,n.useRef)(null),V=(0,n.useRef)(null),J=(0,n.useRef)(null),q=(0,n.useRef)(0);(0,n.useEffect)(()=>(L(),()=>{B.current&&clearInterval(B.current)}),[]);let L=async()=>{let{data:{session:e}}=await i.O.auth.getSession();if(!e){F.push("/login");return}D(!0);try{let t=await (0,l.De)(e.user.id);T(t.canCreate),t.canCreate||O(t.reason||"Cannot create more invoices")}catch(e){console.error("Error checking plan access:",e),T(!0)}finally{D(!1)}},Y=async()=>{if(!A){E(_||"Cannot create more invoices");return}try{E(null),f(null),b(null),y(null),v(null),h(0),q.current=Date.now(),M.current=[];let e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:44100}}),t="audio/webm";MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?t="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?t="audio/ogg;codecs=opus":MediaRecorder.isTypeSupported("audio/mp4")&&(t="audio/mp4"),console.log("Using MIME type:",t);let a=new AudioContext;z.current=a;let r=a.createAnalyser();V.current=r,a.createMediaStreamSource(e).connect(r),r.fftSize=256;let n=new Uint8Array(r.frequencyBinCount),s=()=>{r.getByteFrequencyData(n);let e=n.reduce((e,t)=>e+t)/n.length;k(Math.round(e)),J.current=requestAnimationFrame(s)};s();let i=new MediaRecorder(e,{mimeType:t});U.current=i,i.ondataavailable=e=>{e.data.size>0&&(M.current.push(e.data),console.log("Chunk size:",e.data.size))},i.onstop=async()=>{let a=Date.now()-q.current;if(e.getTracks().forEach(e=>e.stop()),a<1e3){E("Recording too short (minimum 1 second)");return}console.log("Audio chunks:",M.current.length,"Total size:",M.current.reduce((e,t)=>e+t.size,0));let r=new Blob(M.current,{type:t});console.log("Final blob size:",r.size,"type:",r.type),await G(r)},i.start(100),d(!0),B.current=setInterval(()=>{h(e=>{let t=e+1;return t>=180?(Z(),E("Max recording length is 3 minutes"),180):t})},1e3)}catch(e){console.error("Error starting recording:",e),E("Failed to access microphone. Please grant permission and try again.")}},Z=()=>{U.current&&u&&(U.current.stop(),d(!1),k(0),B.current&&(clearInterval(B.current),B.current=null),J.current&&(cancelAnimationFrame(J.current),J.current=null),z.current&&(z.current.close(),z.current=null))},G=async e=>{N(!0),E(null);try{let{data:{session:t}}=await i.O.auth.getSession();if(!t)throw Error("Not authenticated");let a=new File([e],"recording.webm",{type:e.type});if(a.size>26214400)throw Error("Recording too large. Please record a shorter message.");let r=new FormData;r.append("file",a);let n=await fetch("".concat("https://nidijdprgoauwkmuioer.supabase.co","/functions/v1/transcribe"),{method:"POST",headers:{Authorization:"Bearer ".concat(t.access_token)},body:r});if(!n.ok){let e=await n.json();if(429===n.status)throw Error("Rate limit exceeded. Max 10 recordings per hour.");throw Error(e.error||"Transcription failed")}let{text:s}=await n.json();b(s);let o=await fetch("".concat("https://nidijdprgoauwkmuioer.supabase.co","/functions/v1/clean-transcript"),{method:"POST",headers:{Authorization:"Bearer ".concat(t.access_token),"Content-Type":"application/json"},body:JSON.stringify({rawTranscript:s})});if(!o.ok)throw Error("Transcript cleaning failed");let{cleanedTranscript:c}=await o.json();f(c),await X(c)}catch(e){console.error("Transcription error:",e),E(e.message||"Failed to transcribe audio")}finally{N(!1)}},X=async t=>{I(!0),E(null);try{let{data:{session:r}}=await i.O.auth.getSession();if(!r)throw Error("Not authenticated");let n=await fetch("".concat("https://nidijdprgoauwkmuioer.supabase.co","/functions/v1/extract-invoice"),{method:"POST",headers:{Authorization:"Bearer ".concat(r.access_token),"Content-Type":"application/json"},body:JSON.stringify({transcript:t,trade:e})});if(!n.ok){let e=await n.json();if(e.error.includes("Suspicious input"))throw Error("Suspicious input detected. Please record a normal invoice description.");throw Error(e.error||"Extraction failed")}let{invoice:s}=await n.json(),o=await (0,c.T)(r.user.id,s.customerName),{canUseVAT:l,canUseCIS:u}=await Promise.resolve().then(a.bind(a,4407)),d=await l(r.user.id),m=await u(r.user.id),h=d&&s.vatRegistered,p=m&&s.cisJob,{data:f,error:x}=await i.O.from("invoices").insert({user_id:r.user.id,customer_id:o,customer_name:s.customerName,job_summary:s.jobSummary,labour_hours:s.labourHours,labour_rate:45,cis_job:p,cis_rate:p?20:0,vat_registered:h,vat_rate:h?20:0,status:"draft",notes:s.notes}).select().single();if(x)throw x;if(!f)throw Error("Failed to create invoice record");try{await i.O.from("usage_events").insert({user_id:r.user.id,event_type:"invoice_created",invoice_id:f.id})}catch(e){console.warn("Failed to log usage event:",e)}if(s.materials.length>0){let e=s.materials.filter(e=>null!==e.cost).map(e=>({invoice_id:f.id,description:e.description,cost:e.cost,quantity:1}));e.length>0&&await i.O.from("materials").insert(e)}y(s),v(f.id)}catch(e){console.error("Extraction error:",e),E(e.message||"Failed to extract invoice data")}finally{I(!1)}},{mins:H,secs:Q}={mins:Math.floor(m/60),secs:m%60},W=u&&Q%2==0;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"w-full h-12 flex items-center justify-center border-b transition-colors duration-snap ".concat(u?"bg-yapmate-status-red border-yapmate-status-red":"bg-yapmate-black border-yapmate-slate-700 dark:border-yapmate-slate-700"),style:u?void 0:{backgroundImage:"repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(51, 65, 85, 0.3) 10px, rgba(51, 65, 85, 0.3) 20px)"},children:(0,r.jsx)("span",{className:"section-header border-0 py-0",children:u?"/ / RECORDING IN PROGRESS":j?"/ / PROCESSING AUDIO":S?"/ / EXTRACTING DATA":"/ / SYSTEM READY"})}),(0,r.jsxs)("main",{className:"min-h-screen flex flex-col",children:[(0,r.jsxs)("div",{className:"data-row",children:[(0,r.jsx)("span",{className:"data-label",children:"TRADE"}),(0,r.jsxs)("select",{value:e,onChange:e=>t(e.target.value),disabled:u||j||S,className:"bg-transparent border-none text-white font-mono text-sm uppercase focus:outline-none disabled:opacity-50",children:[(0,r.jsx)("option",{value:"Plumber",children:"PLUMBER"}),(0,r.jsx)("option",{value:"Electrician",children:"ELECTRICIAN"}),(0,r.jsx)("option",{value:"Joiner",children:"JOINER"}),(0,r.jsx)("option",{value:"Painter & Decorator",children:"PAINTER"}),(0,r.jsx)("option",{value:"Other",children:"OTHER"})]})]}),(0,r.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center px-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-center mb-12",children:[(0,r.jsx)("span",{className:"text-8xl font-mono font-bold tabular-nums",children:H.toString().padStart(2,"0")}),(0,r.jsx)("span",{className:"text-8xl font-mono font-bold mx-2 transition-opacity duration-0 ".concat(W?"opacity-0":"opacity-100"),children:":"}),(0,r.jsx)("span",{className:"text-8xl font-mono font-bold tabular-nums",children:Q.toString().padStart(2,"0")})]}),u&&(0,r.jsxs)("div",{className:"w-full max-w-md mb-8",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("span",{className:"data-label",children:"INPUT LEVEL"}),(0,r.jsxs)("span",{className:"font-mono text-sm",children:[R," dB"]})]}),(0,r.jsx)("div",{className:"w-full h-3 border border-yapmate-slate-700 dark:border-yapmate-slate-700",children:(0,r.jsx)("div",{className:"h-full bg-yapmate-status-green transition-none",style:{width:"".concat(Math.min(100,R/128*100),"%")}})})]}),u?(0,r.jsx)("button",{onClick:Z,className:"w-32 h-32 bg-yapmate-slate-900 flex items-center justify-center transition-transform duration-0 active:scale-98 border-2 border-yapmate-slate-700",style:{transform:"scale(1)"},children:(0,r.jsx)("div",{className:"w-12 h-12 bg-yapmate-white"})}):(0,r.jsx)("button",{onClick:Y,disabled:j||S||!A||P,className:"w-32 h-32 bg-yapmate-status-red disabled:bg-yapmate-slate-700 disabled:cursor-not-allowed flex items-center justify-center transition-transform duration-0 active:scale-98 border-2 border-yapmate-black dark:border-yapmate-black",style:{transform:"scale(1)"},children:(0,r.jsx)("div",{className:"w-12 h-12 bg-yapmate-white"})})]}),!A&&_&&!C&&(0,r.jsx)("div",{className:"w-full bg-[#2A2A2A] border-y border-[#3A3A3A] py-4 px-4",children:(0,r.jsxs)("div",{className:"max-w-md mx-auto text-center",children:[(0,r.jsx)("span",{className:"data-label text-[#F97316]",children:"FREE PLAN LIMIT REACHED"}),(0,r.jsx)("p",{className:"text-[#F2F2F2] font-mono text-sm mt-2 mb-3",children:_}),(0,r.jsx)("p",{className:"text-[#8A8A8A] text-sm mb-3",children:"Upgrade to Pro to create unlimited invoices"}),(0,r.jsx)("button",{onClick:()=>F.push("/pricing"),className:"bg-[#F97316] text-[#0B0B0B] font-semibold px-6 py-3 rounded-[4px] text-sm uppercase tracking-wide",children:"View Plans"})]})}),C&&(0,r.jsxs)("div",{className:"w-full bg-yapmate-status-red border-y border-yapmate-black py-3 px-4",children:[(0,r.jsx)("span",{className:"data-label text-yapmate-black",children:"ERROR"}),(0,r.jsx)("p",{className:"text-yapmate-black font-mono text-sm mt-1",children:C})]}),p&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"section-header",children:"// TRANSCRIPT"}),(0,r.jsx)("div",{className:"px-4 py-4 border-b border-yapmate-slate-700 dark:border-yapmate-slate-700",children:(0,r.jsx)("p",{className:"font-mono text-sm leading-relaxed",children:p})})]}),g&&w&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"section-header",children:"// INVOICE CREATED"}),(0,r.jsxs)("div",{className:"data-row",children:[(0,r.jsx)("span",{className:"data-label",children:"STATUS"}),(0,r.jsx)("span",{className:"status-badge text-yapmate-status-green",children:"READY"})]}),(0,r.jsxs)("div",{className:"data-row",children:[(0,r.jsx)("span",{className:"data-label",children:"CUSTOMER"}),(0,r.jsx)("span",{className:"data-value mono text-base",children:g.customerName||"UNSPECIFIED"})]}),(0,r.jsxs)("div",{className:"data-row border-b-0",children:[(0,r.jsx)("span",{className:"data-label",children:"JOB"}),(0,r.jsx)("span",{className:"font-mono text-sm text-right max-w-[60%]",children:g.jobSummary})]})]}),(0,r.jsx)("div",{className:"h-32"})]}),g&&w&&(0,r.jsx)("div",{className:"fixed left-0 right-0 z-50",style:{bottom:"68px"},children:(0,r.jsx)("button",{onClick:()=>F.push("/invoice?id=".concat(w)),className:"bar-button h-14",children:"REVIEW INVOICE"})}),(0,r.jsx)(o.Z,{})]})}},6079:function(e,t,a){"use strict";a.d(t,{Z:function(){return i}});var r=a(7437),n=a(7138),s=a(6463);function i(){let e=(0,s.usePathname)();return(0,r.jsx)("nav",{className:"fixed bottom-0 left-0 right-0 bg-yapmate-black/95 backdrop-blur-lg border-t border-yapmate-slate-800 pb-safe",children:(0,r.jsx)("div",{className:"flex justify-around items-center",style:{height:"68px"},children:[{href:"/record",label:"Record",icon:"\uD83C\uDFA4"},{href:"/dashboard",label:"Invoices",icon:"\uD83D\uDCC4"},{href:"/customers",label:"Customers",icon:"\uD83D\uDC65"},{href:"/settings",label:"Settings",icon:"⚙️"}].map(t=>{let a=e===t.href;return(0,r.jsxs)(n.default,{href:t.href,className:"flex flex-col items-center justify-center flex-1 h-full transition-colors duration-200 tap-highlight ".concat(a?"text-yapmate-amber-500":"text-yapmate-slate-400 active:text-yapmate-slate-200"),children:[(0,r.jsx)("span",{className:"text-2xl mb-1",children:t.icon}),(0,r.jsx)("span",{className:"text-xs font-semibold",children:t.label})]},t.href)})})})}},146:function(e,t,a){"use strict";a.d(t,{T:function(){return s}});var r=a(6881);function n(e){let t=e.replace(/\D/g,"");return t.startsWith("44")&&t.length>=11&&t.length<=13?"0"+t.substring(2):t}async function s(e,t,a,s){if(!t||""===t.trim())return null;let i=(0,r.createBrowserClient)(),o=t.trim(),c=(null==a?void 0:a.trim().toLowerCase())||null,l=s?n(s.trim()):null;try{if(c){let{data:t,error:a}=await i.from("customers").select("id").eq("user_id",e).ilike("email",c).limit(1);if(a)throw a;if(t&&t.length>0)return t[0].id}if(l&&l.length>0){let{data:t,error:a}=await i.from("customers").select("id, phone").eq("user_id",e).not("phone","is",null);if(a)throw a;if(t&&t.length>0){let e=t.find(e=>n(e.phone||"")===l);if(e)return e.id}}if(!c&&!l){let{data:t,error:a}=await i.from("customers").select("id").eq("user_id",e).ilike("name",o).limit(1);if(a)throw a;if(t&&t.length>0)return t[0].id}let{data:t,error:a}=await i.from("customers").insert({user_id:e,name:o,email:c,phone:l||null}).select("id").single();if(a)throw a;return t.id}catch(e){throw console.error("Error in ensureCustomer:",e),e}}},4407:function(e,t,a){"use strict";a.d(t,{De:function(){return o},Fk:function(){return s},Nt:function(){return u},canUseCIS:function(){return l},canUseVAT:function(){return c}});var r=a(6881);let n={free:{maxInvoices:3,canUseVAT:!1,canUseCIS:!1},pro:{maxInvoices:null,canUseVAT:!0,canUseCIS:!1},trade:{maxInvoices:null,canUseVAT:!0,canUseCIS:!0}};async function s(e){let t=(0,r.createBrowserClient)(),{data:a,error:n}=await t.from("user_preferences").select("plan").eq("user_id",e).single();return n||!a?(console.warn("Failed to fetch user plan, defaulting to free:",n),"free"):a.plan}async function i(e){let t=(0,r.createBrowserClient)(),{count:a,error:n}=await t.from("invoices").select("*",{count:"exact",head:!0}).eq("user_id",e);return n?(console.error("Failed to fetch invoice count:",n),0):a||0}async function o(e){let t=n[await s(e)];if(null===t.maxInvoices)return{canCreate:!0};let a=await i(e);return a>=t.maxInvoices?{canCreate:!1,reason:"You've reached the limit of ".concat(t.maxInvoices," invoices on the free plan"),currentCount:a,limit:t.maxInvoices}:{canCreate:!0,currentCount:a,limit:t.maxInvoices}}async function c(e){return n[await s(e)].canUseVAT}async function l(e){return n[await s(e)].canUseCIS}function u(e){return({free:"Free",pro:"Pro",trade:"Trade"})[e]}},6881:function(e,t,a){"use strict";a.d(t,{O:function(){return i},createBrowserClient:function(){return c}});var r=a(7204);a(4392);let n="https://nidijdprgoauwkmuioer.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZGlqZHByZ29hdXdrbXVpb2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMDc4NzcsImV4cCI6MjA4MDc4Mzg3N30.kpCiLgYxayUlUOPM0Uip1QsT5wnBpj7gv8yLKOB0vDY";if(!n||!s)throw Error("Missing Supabase environment variables");let i=(0,r.eI)(n,s),o=null;function c(){return o||(o=(0,r.eI)(n,s))}},7138:function(e,t,a){"use strict";a.d(t,{default:function(){return n.a}});var r=a(231),n=a.n(r)},6463:function(e,t,a){"use strict";var r=a(1169);a.o(r,"usePathname")&&a.d(t,{usePathname:function(){return r.usePathname}}),a.o(r,"useRouter")&&a.d(t,{useRouter:function(){return r.useRouter}}),a.o(r,"useSearchParams")&&a.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[392,231,971,23,744],function(){return e(e.s=77)}),_N_E=e.O()}]);