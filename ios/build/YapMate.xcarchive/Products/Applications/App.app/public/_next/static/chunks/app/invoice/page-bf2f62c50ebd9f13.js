(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[206,881],{2480:function(){},8358:function(e,t,a){Promise.resolve().then(a.bind(a,408))},408:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return b}});var s=a(7437),r=a(2265),o=a(6463),n=a(6881),l=a(6079),i=a(6251),c=a(5323);let d=c.mM.create({page:{padding:40,fontSize:10,fontFamily:"Helvetica"},header:{flexDirection:"row",justifyContent:"space-between",marginBottom:40,borderBottomWidth:1,borderBottomColor:"#eee",paddingBottom:20},logoContainer:{width:100},logo:{width:80,height:80,objectFit:"contain"},headerRight:{textAlign:"right"},title:{fontSize:24,fontWeight:"bold",color:"#000",marginBottom:5},companyInfo:{fontSize:9,color:"#666",marginBottom:3},section:{marginBottom:25},sectionTitle:{fontSize:11,fontWeight:"bold",marginBottom:8,color:"#000",textTransform:"uppercase",letterSpacing:1,borderBottomWidth:.5,borderBottomColor:"#ccc",paddingBottom:3},row:{flexDirection:"row",justifyContent:"space-between",marginBottom:5},table:{marginTop:5},tableHeader:{flexDirection:"row",backgroundColor:"#f9f9f9",paddingVertical:8,paddingHorizontal:5,borderBottomWidth:1,borderBottomColor:"#ddd"},tableHeaderCell:{fontSize:9,fontWeight:"bold",color:"#444"},tableRow:{flexDirection:"row",paddingVertical:8,paddingHorizontal:5,borderBottomWidth:.5,borderBottomColor:"#eee"},col1:{width:"60%"},col2:{width:"15%",textAlign:"right"},col3:{width:"25%",textAlign:"right"},totalsSection:{marginTop:20,marginLeft:"auto",width:"50%"},totalRow:{flexDirection:"row",justifyContent:"space-between",marginBottom:8,fontSize:10},grandTotal:{flexDirection:"row",justifyContent:"space-between",marginTop:10,paddingTop:10,borderTopWidth:2,borderTopColor:"#000",fontSize:14,fontWeight:"bold"},notesSection:{marginTop:30,padding:10,backgroundColor:"#f9f9f9",borderRadius:4},notesTitle:{fontSize:10,fontWeight:"bold",marginBottom:5},notesText:{fontSize:9,color:"#444"},footer:{position:"absolute",bottom:30,left:40,right:40,textAlign:"center",fontSize:8,color:"#999",borderTopWidth:1,borderTopColor:"#eee",paddingTop:10}}),m=e=>!1===e||null===e;var u=e=>{var t;let{invoice:a,calculations:r,bankDetails:o}=e;return(0,s.jsx)(c.BB,{children:(0,s.jsxs)(c.T3,{size:"A4",style:d.page,children:[(0,s.jsxs)(c.G7,{style:d.header,children:[(0,s.jsx)(c.G7,{style:d.logoContainer,children:(0,s.jsx)(c.Ee,{src:"https://yapmate.vercel.app/yapmatetransparetnew112.png",style:d.logo})}),(0,s.jsxs)(c.G7,{style:d.headerRight,children:[(0,s.jsx)(c.xv,{style:d.title,children:"INVOICE"}),(0,s.jsxs)(c.xv,{style:d.companyInfo,children:["Invoice #: ",a.id.slice(0,8).toUpperCase()]}),(0,s.jsxs)(c.xv,{style:d.companyInfo,children:["Date: ",new Date(a.created_at).toLocaleDateString("en-GB")]})]})]}),(0,s.jsxs)(c.G7,{style:d.section,children:[(0,s.jsx)(c.xv,{style:d.sectionTitle,children:"Bill To"}),(0,s.jsx)(c.xv,{style:{fontSize:12,marginBottom:2},children:(null===(t=a.customer)||void 0===t?void 0:t.name)||a.customer_name||"Valued Customer"})]}),(0,s.jsxs)(c.G7,{style:d.section,children:[(0,s.jsx)(c.xv,{style:d.sectionTitle,children:"Job Description"}),(0,s.jsx)(c.xv,{style:{lineHeight:1.4},children:a.job_summary})]}),(0,s.jsxs)(c.G7,{style:d.section,children:[(0,s.jsx)(c.xv,{style:d.sectionTitle,children:"Items"}),(0,s.jsxs)(c.G7,{style:d.table,children:[(0,s.jsxs)(c.G7,{style:d.tableHeader,children:[(0,s.jsx)(c.xv,{style:[d.col1,d.tableHeaderCell],children:"Description"}),(0,s.jsx)(c.xv,{style:[d.col2,d.tableHeaderCell],children:"Qty"}),(0,s.jsx)(c.xv,{style:[d.col3,d.tableHeaderCell],children:"Amount"})]}),a.labour_hours&&a.labour_hours>0&&(0,s.jsxs)(c.G7,{style:d.tableRow,children:[(0,s.jsxs)(c.xv,{style:d.col1,children:["Labour (",a.labour_hours," hrs @ \xa3",a.labour_rate.toFixed(2),"/hr)"]}),(0,s.jsx)(c.xv,{style:d.col2,children:"1"}),(0,s.jsx)(c.xv,{style:d.col3,children:(0,i.xG)(r.labourSubtotal)})]}),a.materials.map((e,t)=>(0,s.jsxs)(c.G7,{style:d.tableRow,children:[(0,s.jsx)(c.xv,{style:d.col1,children:e.description}),(0,s.jsx)(c.xv,{style:d.col2,children:e.quantity}),(0,s.jsx)(c.xv,{style:d.col3,children:(0,i.xG)(e.cost*e.quantity)})]},t))]})]}),(0,s.jsxs)(c.G7,{style:d.totalsSection,children:[(0,s.jsxs)(c.G7,{style:d.totalRow,children:[(0,s.jsx)(c.xv,{children:"Subtotal (Labour + Materials)"}),(0,s.jsx)(c.xv,{children:(0,i.xG)(r.subtotal)})]}),!m(a.vat_registered)&&(0,s.jsxs)(c.G7,{style:d.totalRow,children:[(0,s.jsxs)(c.xv,{children:["VAT (",a.vat_rate,"%)"]}),(0,s.jsx)(c.xv,{children:(0,i.xG)(r.vatAmount)})]}),(0,s.jsxs)(c.G7,{style:d.grandTotal,children:[(0,s.jsx)(c.xv,{children:"INVOICE TOTAL"}),(0,s.jsx)(c.xv,{children:(0,i.xG)(r.invoiceTotal)})]}),!m(a.cis_job)&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(c.G7,{style:[d.totalRow,{marginTop:10,paddingTop:10,borderTopWidth:1,borderTopColor:"#ccc"}],children:[(0,s.jsxs)(c.xv,{style:{fontSize:9,color:"#666"},children:["CIS withheld by contractor (",a.cis_rate,"% of labour)"]}),(0,s.jsx)(c.xv,{style:{fontSize:9,color:"#666"},children:(0,i.xG)(r.cisDeduction)})]}),(0,s.jsxs)(c.G7,{style:d.totalRow,children:[(0,s.jsx)(c.xv,{style:{fontWeight:"bold"},children:"Net Payment to Contractor"}),(0,s.jsx)(c.xv,{style:{fontWeight:"bold"},children:(0,i.xG)(r.netPayment)})]})]})]}),a.notes&&(0,s.jsxs)(c.G7,{style:d.notesSection,children:[(0,s.jsx)(c.xv,{style:d.notesTitle,children:"Payment Terms & Notes"}),(0,s.jsx)(c.xv,{style:d.notesText,children:a.notes})]}),o&&(0,s.jsxs)(c.G7,{style:{marginTop:30,padding:15,backgroundColor:"#f9f9f9",borderWidth:1,borderColor:"#ddd"},children:[(0,s.jsx)(c.xv,{style:{fontSize:11,fontWeight:"bold",marginBottom:10,textTransform:"uppercase",letterSpacing:1},children:"Payment Details"}),(0,s.jsxs)(c.G7,{style:{fontSize:9,lineHeight:1.6},children:[(0,s.jsxs)(c.G7,{style:{flexDirection:"row",marginBottom:4},children:[(0,s.jsx)(c.xv,{style:{width:"40%",fontWeight:"bold"},children:"Account Name:"}),(0,s.jsx)(c.xv,{style:{width:"60%"},children:o.accountName})]}),(0,s.jsxs)(c.G7,{style:{flexDirection:"row",marginBottom:4},children:[(0,s.jsx)(c.xv,{style:{width:"40%",fontWeight:"bold"},children:"Sort Code:"}),(0,s.jsx)(c.xv,{style:{width:"60%"},children:o.sortCode})]}),(0,s.jsxs)(c.G7,{style:{flexDirection:"row",marginBottom:4},children:[(0,s.jsx)(c.xv,{style:{width:"40%",fontWeight:"bold"},children:"Account Number:"}),(0,s.jsx)(c.xv,{style:{width:"60%"},children:o.accountNumber})]}),(0,s.jsxs)(c.G7,{style:{flexDirection:"row"},children:[(0,s.jsx)(c.xv,{style:{width:"40%",fontWeight:"bold"},children:"Payment Reference:"}),(0,s.jsx)(c.xv,{style:{width:"60%"},children:o.paymentReference})]})]})]}),(0,s.jsxs)(c.G7,{style:d.footer,children:[(0,s.jsx)(c.xv,{children:"Thank you for your business"}),(0,s.jsx)(c.xv,{style:{marginTop:2},children:"Generated by YapMate - The Tradie's Voice Assistant"})]})]})})},x=a(146),h=a(4407);function p(){var e,t,d,m,p;let b=(0,o.useSearchParams)().get("id"),f=(0,o.useRouter)(),[y,j]=(0,r.useState)(!0),[v,g]=(0,r.useState)(!1),[w,N]=(0,r.useState)(!1),[_,C]=(0,r.useState)(null),[k,I]=(0,r.useState)(null),[T,S]=(0,r.useState)([]),[G,D]=(0,r.useState)(null),[B,A]=(0,r.useState)(!0);(0,r.useEffect)(()=>{b?(O(),F(b),R()):j(!1)},[b]);let O=async()=>{let{data:{session:e}}=await n.O.auth.getSession();e||f.push("/login")},F=async e=>{try{let{data:t,error:a}=await n.O.from("invoices").select("*, materials(*), customer:customers(name, email, phone)").eq("id",e).single();if(a)throw a;if(!t)throw Error("Invoice not found");I(t),S(t.materials||[])}catch(e){console.error("Error fetching invoice:",e),D("Failed to load invoice")}finally{j(!1)}},R=async()=>{try{let{data:{session:e}}=await n.O.auth.getSession();if(!e)return;let{data:t,error:a}=await n.O.from("user_preferences").select("bank_account_name, bank_sort_code, bank_account_number").eq("user_id",e.user.id).single();a&&"PGRST116"!==a.code&&console.error("Error checking bank details:",a);let s=t&&t.bank_account_name&&t.bank_sort_code&&t.bank_account_number;A(!!s)}catch(e){console.error("Error checking bank details:",e)}},U=async()=>{if(b&&k){g(!0),D(null);try{let{data:{user:e}}=await n.O.auth.getUser();if(!e)throw Error("Not authenticated");let t=await (0,h.canUseVAT)(e.id),a=await (0,h.canUseCIS)(e.id),s=!!t&&k.vat_registered,r=!!a&&k.cis_job,o=null,l=null;k.customer_id&&k.customer&&(o=k.customer.email,l=k.customer.phone);let i=await (0,x.T)(e.id,k.customer_name,o,l),{error:c}=await n.O.from("invoices").update({customer_id:i,customer_name:k.customer_name,job_summary:k.job_summary,labour_hours:k.labour_hours,labour_rate:k.labour_rate,cis_job:r,cis_rate:r?k.cis_rate:0,vat_registered:s,vat_rate:s?k.vat_rate:0,notes:k.notes,status:k.status}).eq("id",b);if(c)throw c;await n.O.from("materials").delete().eq("invoice_id",b);let d=T.map(e=>{let{id:t,...a}=e;return{...a,invoice_id:b}});if(d.length>0){let{error:e}=await n.O.from("materials").insert(d);if(e)throw e}f.push("/dashboard")}catch(e){console.error(e),D(e.message||"Failed to save invoice")}finally{g(!1)}}},E=e=>{S(T.filter((t,a)=>a!==e))},z=(e,t,a)=>{let s=[...T];s[e]={...s[e],[t]:a},S(s)},V=async()=>{if(k){N(!0),C(null);try{var e;let{data:{session:t}}=await n.O.auth.getSession(),r=null;if(t){let{data:e}=await n.O.from("user_preferences").select("bank_account_name, bank_sort_code, bank_account_number, payment_reference").eq("user_id",t.user.id).single();e&&e.bank_account_name&&e.bank_sort_code&&e.bank_account_number&&(r={accountName:e.bank_account_name,sortCode:e.bank_sort_code,accountNumber:e.bank_account_number,paymentReference:e.payment_reference||k.id.slice(0,8).toUpperCase()})}let o=(0,i.IG)(k.labour_hours,k.labour_rate,T.map(e=>({cost:e.cost,quantity:e.quantity})),k.cis_job,k.cis_rate,k.vat_registered,k.vat_rate),l={...k,materials:T},d=await (0,c.eA)((0,s.jsx)(u,{invoice:l,calculations:o,bankDetails:r})).toBlob(),m=(null===(e=k.customer)||void 0===e?void 0:e.name)||k.customer_name||"draft",x="invoice-".concat(m,"-").concat(new Date().toISOString().split("T")[0],".pdf");if(void 0!==window.Capacitor){let{Filesystem:e,Directory:t}=await Promise.all([a.e(790),a.e(420)]).then(a.bind(a,3420)),{Share:s}=await Promise.all([a.e(790),a.e(128)]).then(a.bind(a,1744)),r=new FileReader,o=await new Promise(e=>{r.onloadend=()=>{let t=r.result.split(",")[1];e(t)},r.readAsDataURL(d)}),n=await e.writeFile({path:x,data:o,directory:t.Cache});await s.share({title:"Invoice PDF",text:"Invoice for ".concat(k.customer_name||"customer"),url:n.uri,dialogTitle:"Share Invoice"})}else{let e=URL.createObjectURL(d),t=document.createElement("a");t.href=e,t.download=x,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}}catch(e){console.error("PDF generation error:",e),C(e.message||"Failed to generate PDF")}finally{N(!1)}}};if(y)return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsx)("span",{className:"font-mono text-sm text-yapmate-slate-300",children:"/ / LOADING INVOICE"})}),(0,s.jsx)(l.Z,{})]});if(!k)return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("span",{className:"font-mono text-sm text-yapmate-status-red",children:"/ / INVOICE NOT FOUND"}),(0,s.jsx)("button",{onClick:()=>f.push("/dashboard"),className:"block mt-4 mx-auto text-yapmate-amber hover:text-yapmate-status-yellow font-mono text-xs uppercase",children:"← Back to Dashboard"})]})}),(0,s.jsx)(l.Z,{})]});let P=(0,i.IG)(k.labour_hours,k.labour_rate,T.map(e=>({cost:e.cost,quantity:e.quantity})),null!==(t=k.cis_job)&&void 0!==t&&t,k.cis_rate,null!==(d=k.vat_registered)&&void 0!==d&&d,k.vat_rate);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("main",{className:"min-h-screen bg-yapmate-black pb-32",children:[(0,s.jsxs)("div",{className:"border-b border-yapmate-slate-700 px-4 py-4 flex items-center justify-between",children:[(0,s.jsx)("button",{onClick:()=>f.push("/dashboard"),className:"text-yapmate-slate-300 active:text-yapmate-amber font-mono text-xs uppercase",children:"← Back"}),(0,s.jsx)("h1",{className:"font-mono text-base font-bold text-yapmate-white uppercase",children:"Edit Invoice"}),(0,s.jsx)("div",{className:"w-16"})]}),G&&(0,s.jsx)("div",{className:"mx-4 mt-4 border-2 border-yapmate-status-red bg-yapmate-status-red/10 p-4",children:(0,s.jsx)("p",{className:"text-yapmate-status-red text-sm font-mono",children:G})}),(0,s.jsxs)("div",{className:"p-4 space-y-6",children:[(0,s.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-4",children:[(0,s.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono uppercase mb-2",children:"Customer"}),(0,s.jsx)("input",{type:"text",value:(null===(e=k.customer)||void 0===e?void 0:e.name)||k.customer_name||"",onChange:e=>I({...k,customer_name:e.target.value}),className:"w-full px-4 py-3 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white text-lg font-bold focus:outline-none focus:border-yapmate-amber transition-colors duration-snap",placeholder:"Customer name"})]}),(0,s.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-4",children:[(0,s.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono uppercase mb-2",children:"Job Summary"}),(0,s.jsx)("textarea",{value:k.job_summary||"",onChange:e=>I({...k,job_summary:e.target.value}),rows:3,className:"w-full px-4 py-3 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white focus:outline-none focus:border-yapmate-amber transition-colors duration-snap resize-none",placeholder:"Job description"})]}),(0,s.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-4",children:[(0,s.jsx)("div",{className:"flex items-center justify-between mb-2",children:(0,s.jsx)("span",{className:"text-yapmate-slate-300 text-xs font-mono uppercase",children:"Labour"})}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono mb-1",children:"Hours"}),(0,s.jsx)("input",{type:"number",step:"0.25",value:k.labour_hours||"",onChange:e=>I({...k,labour_hours:parseFloat(e.target.value)||0}),className:"w-full px-3 py-2 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white text-xl font-mono font-bold focus:outline-none focus:border-yapmate-amber transition-colors duration-snap"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono mb-1",children:"Rate (\xa3/hr)"}),(0,s.jsx)("input",{type:"number",step:"0.01",value:k.labour_rate||"",onChange:e=>I({...k,labour_rate:parseFloat(e.target.value)||0}),className:"w-full px-3 py-2 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white text-xl font-mono font-bold focus:outline-none focus:border-yapmate-amber transition-colors duration-snap"})]})]}),k.labour_hours>0&&k.labour_rate>0&&(0,s.jsx)("div",{className:"mt-2 text-right",children:(0,s.jsx)("span",{className:"text-yapmate-amber font-mono text-lg font-bold",children:(0,i.xG)(P.labourSubtotal)})})]}),(0,s.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsx)("span",{className:"text-yapmate-slate-300 text-xs font-mono uppercase",children:"Materials"}),(0,s.jsx)("button",{onClick:()=>{S([...T,{description:"",cost:0,quantity:1}])},className:"text-yapmate-amber font-mono text-xs uppercase active:text-yapmate-status-yellow",children:"+ Add"})]}),(0,s.jsx)("div",{className:"space-y-3",children:T.map((e,t)=>(0,s.jsxs)("div",{className:"border border-yapmate-slate-700 p-3",children:[(0,s.jsx)("input",{type:"text",value:e.description||"",onChange:e=>z(t,"description",e.target.value),className:"w-full mb-2 px-2 py-1 bg-yapmate-black border border-yapmate-slate-700 text-yapmate-white text-sm focus:outline-none focus:border-yapmate-amber",placeholder:"Description"}),(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,s.jsx)("input",{type:"number",step:"1",value:e.quantity||"",onChange:e=>z(t,"quantity",parseInt(e.target.value)||0),className:"px-2 py-1 bg-yapmate-black border border-yapmate-slate-700 text-yapmate-white text-sm font-mono focus:outline-none focus:border-yapmate-amber",placeholder:"Qty"}),(0,s.jsx)("input",{type:"number",step:"0.01",value:e.cost||"",onChange:e=>z(t,"cost",parseFloat(e.target.value)||0),className:"px-2 py-1 bg-yapmate-black border border-yapmate-slate-700 text-yapmate-white text-sm font-mono focus:outline-none focus:border-yapmate-amber",placeholder:"\xa3"}),(0,s.jsx)("button",{onClick:()=>E(t),className:"text-yapmate-status-red font-mono text-xs uppercase active:bg-yapmate-status-red active:text-yapmate-black border border-yapmate-status-red",children:"Del"})]})]},t))})]}),(0,s.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-4 space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"flex items-center justify-between",children:[(0,s.jsx)("span",{className:"text-yapmate-white text-xs font-mono uppercase",children:"CIS Job"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("input",{type:"checkbox",checked:null!==(m=k.cis_job)&&void 0!==m&&m,onChange:e=>I({...k,cis_job:e.target.checked}),className:"sr-only peer"}),(0,s.jsx)("div",{className:"w-12 h-6 border-2 border-yapmate-slate-700 peer-checked:bg-yapmate-amber peer-checked:border-yapmate-amber"}),(0,s.jsx)("div",{className:"absolute left-0.5 top-0.5 w-5 h-5 bg-yapmate-white peer-checked:translate-x-6 transition-transform duration-snap"})]})]}),(0,s.jsxs)("p",{className:"text-yapmate-slate-400 text-xs font-mono mt-1",children:["Contractor withholds ",k.cis_rate,"% from labour only"]})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"flex items-center justify-between",children:[(0,s.jsx)("span",{className:"text-yapmate-white text-xs font-mono uppercase",children:"Add VAT"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("input",{type:"checkbox",checked:null!==(p=k.vat_registered)&&void 0!==p&&p,onChange:e=>I({...k,vat_registered:e.target.checked}),className:"sr-only peer"}),(0,s.jsx)("div",{className:"w-12 h-6 border-2 border-yapmate-slate-700 peer-checked:bg-yapmate-amber peer-checked:border-yapmate-amber"}),(0,s.jsx)("div",{className:"absolute left-0.5 top-0.5 w-5 h-5 bg-yapmate-white peer-checked:translate-x-6 transition-transform duration-snap"})]})]}),(0,s.jsxs)("p",{className:"text-yapmate-slate-400 text-xs font-mono mt-1",children:["Adds ",k.vat_rate,"% VAT to invoice total (customer pays)"]})]})]}),(0,s.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-4",children:[(0,s.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono uppercase mb-2",children:"Notes / Payment Terms"}),(0,s.jsx)("textarea",{value:k.notes||"",onChange:e=>I({...k,notes:e.target.value}),rows:2,className:"w-full px-4 py-3 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white text-sm focus:outline-none focus:border-yapmate-amber transition-colors duration-snap resize-none",placeholder:"Payment due in 14 days..."})]}),(0,s.jsxs)("div",{className:"border-2 border-yapmate-amber p-4",children:[(0,s.jsxs)("div",{className:"space-y-2 text-sm font-mono",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-yapmate-slate-300",children:"Subtotal (Labour + Materials)"}),(0,s.jsx)("span",{className:"text-yapmate-white font-bold",children:(0,i.xG)(P.subtotal)})]}),k.vat_registered&&(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsxs)("span",{className:"text-yapmate-slate-300",children:["VAT (",k.vat_rate,"%)"]}),(0,s.jsx)("span",{className:"text-yapmate-white font-bold",children:(0,i.xG)(P.vatAmount)})]}),(0,s.jsxs)("div",{className:"flex justify-between pt-2 border-t-2 border-yapmate-white text-lg",children:[(0,s.jsx)("span",{className:"text-yapmate-white font-bold",children:"INVOICE TOTAL"}),(0,s.jsx)("span",{className:"text-yapmate-amber font-bold",children:(0,i.xG)(P.invoiceTotal)})]}),(0,s.jsx)("p",{className:"text-yapmate-slate-400 text-xs",children:"Customer pays this amount"}),k.cis_job&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"flex justify-between pt-2 border-t border-yapmate-slate-700 text-yapmate-status-orange",children:[(0,s.jsxs)("span",{children:["CIS withheld (",k.cis_rate,"% of labour)"]}),(0,s.jsx)("span",{className:"font-bold",children:(0,i.xG)(P.cisDeduction)})]}),(0,s.jsxs)("div",{className:"flex justify-between text-base",children:[(0,s.jsx)("span",{className:"text-yapmate-white font-bold",children:"NET PAYMENT"}),(0,s.jsx)("span",{className:"text-yapmate-status-green font-bold",children:(0,i.xG)(P.netPayment)})]}),(0,s.jsx)("p",{className:"text-yapmate-slate-400 text-xs",children:"You receive this amount"})]})]}),(0,s.jsxs)("div",{className:"mt-4 pt-4 border-t border-yapmate-slate-700",children:[!B&&(0,s.jsx)("p",{className:"mb-3 text-xs text-yapmate-status-yellow font-mono",children:"Add bank details in Settings to include them on invoices"}),(0,s.jsx)("button",{onClick:V,disabled:w,className:"w-full h-12 border-2 border-yapmate-white text-yapmate-white font-mono font-bold uppercase bg-transparent transition-colors duration-snap active:bg-yapmate-white active:text-yapmate-black disabled:opacity-50",children:w?"GENERATING...":"DOWNLOAD PDF"}),_&&(0,s.jsx)("p",{className:"mt-2 text-xs text-yapmate-status-red font-mono",children:_})]})]})]})]}),(0,s.jsx)("div",{className:"fixed bottom-0 left-0 right-0 pb-safe",style:{bottom:"68px"},children:(0,s.jsx)("button",{onClick:U,disabled:v,className:"bar-button h-14",children:v?"SAVING...":"SAVE & RETURN"})}),(0,s.jsx)(l.Z,{})]})}function b(){return(0,s.jsx)(r.Suspense,{fallback:(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsx)("span",{className:"font-mono text-sm text-yapmate-slate-300",children:"/ / LOADING"})}),children:(0,s.jsx)(p,{})})}},6079:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});var s=a(7437),r=a(7138),o=a(6463);function n(){let e=(0,o.usePathname)();return(0,s.jsx)("nav",{className:"fixed bottom-0 left-0 right-0 bg-yapmate-black/95 backdrop-blur-lg border-t border-yapmate-slate-800 pb-safe",children:(0,s.jsx)("div",{className:"flex justify-around items-center",style:{height:"68px"},children:[{href:"/record",label:"Record",icon:"\uD83C\uDFA4"},{href:"/dashboard",label:"Invoices",icon:"\uD83D\uDCC4"},{href:"/customers",label:"Customers",icon:"\uD83D\uDC65"},{href:"/settings",label:"Settings",icon:"⚙️"}].map(t=>{let a=e===t.href;return(0,s.jsxs)(r.default,{href:t.href,className:"flex flex-col items-center justify-center flex-1 h-full transition-colors duration-200 tap-highlight ".concat(a?"text-yapmate-amber-500":"text-yapmate-slate-400 active:text-yapmate-slate-200"),children:[(0,s.jsx)("span",{className:"text-2xl mb-1",children:t.icon}),(0,s.jsx)("span",{className:"text-xs font-semibold",children:t.label})]},t.href)})})})}},146:function(e,t,a){"use strict";a.d(t,{T:function(){return o}});var s=a(6881);function r(e){let t=e.replace(/\D/g,"");return t.startsWith("44")&&t.length>=11&&t.length<=13?"0"+t.substring(2):t}async function o(e,t,a,o){if(!t||""===t.trim())return null;let n=(0,s.createBrowserClient)(),l=t.trim(),i=(null==a?void 0:a.trim().toLowerCase())||null,c=o?r(o.trim()):null;try{if(i){let{data:t,error:a}=await n.from("customers").select("id").eq("user_id",e).ilike("email",i).limit(1);if(a)throw a;if(t&&t.length>0)return t[0].id}if(c&&c.length>0){let{data:t,error:a}=await n.from("customers").select("id, phone").eq("user_id",e).not("phone","is",null);if(a)throw a;if(t&&t.length>0){let e=t.find(e=>r(e.phone||"")===c);if(e)return e.id}}if(!i&&!c){let{data:t,error:a}=await n.from("customers").select("id").eq("user_id",e).ilike("name",l).limit(1);if(a)throw a;if(t&&t.length>0)return t[0].id}let{data:t,error:a}=await n.from("customers").insert({user_id:e,name:l,email:i,phone:c||null}).select("id").single();if(a)throw a;return t.id}catch(e){throw console.error("Error in ensureCustomer:",e),e}}},4407:function(e,t,a){"use strict";a.d(t,{De:function(){return l},Fk:function(){return o},Nt:function(){return d},canUseCIS:function(){return c},canUseVAT:function(){return i}});var s=a(6881);let r={free:{maxInvoices:3,canUseVAT:!1,canUseCIS:!1},pro:{maxInvoices:null,canUseVAT:!0,canUseCIS:!1},trade:{maxInvoices:null,canUseVAT:!0,canUseCIS:!0}};async function o(e){let t=(0,s.createBrowserClient)(),{data:a,error:r}=await t.from("user_preferences").select("plan").eq("user_id",e).single();return r||!a?(console.warn("Failed to fetch user plan, defaulting to free:",r),"free"):a.plan}async function n(e){let t=(0,s.createBrowserClient)(),{count:a,error:r}=await t.from("invoices").select("*",{count:"exact",head:!0}).eq("user_id",e);return r?(console.error("Failed to fetch invoice count:",r),0):a||0}async function l(e){let t=r[await o(e)];if(null===t.maxInvoices)return{canCreate:!0};let a=await n(e);return a>=t.maxInvoices?{canCreate:!1,reason:"You've reached the limit of ".concat(t.maxInvoices," invoices on the free plan"),currentCount:a,limit:t.maxInvoices}:{canCreate:!0,currentCount:a,limit:t.maxInvoices}}async function i(e){return r[await o(e)].canUseVAT}async function c(e){return r[await o(e)].canUseCIS}function d(e){return({free:"Free",pro:"Pro",trade:"Trade"})[e]}},6881:function(e,t,a){"use strict";a.d(t,{O:function(){return n},createBrowserClient:function(){return i}});var s=a(7204);a(4392);let r="https://nidijdprgoauwkmuioer.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZGlqZHByZ29hdXdrbXVpb2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMDc4NzcsImV4cCI6MjA4MDc4Mzg3N30.kpCiLgYxayUlUOPM0Uip1QsT5wnBpj7gv8yLKOB0vDY";if(!r||!o)throw Error("Missing Supabase environment variables");let n=(0,s.eI)(r,o),l=null;function i(){return l||(l=(0,s.eI)(r,o))}},6251:function(e,t,a){"use strict";function s(e,t,a,s,r,o,n){let l=e=>Math.round(100*e)/100,i=l(!e||e<=0?0:e*t),c=l(a.reduce((e,t)=>e+t.cost*t.quantity,0)),d=l(i+c),m=o?l(d<=0?0:d*n/100):0,u=l(d+m),x=s?l(i<=0?0:i*r/100):0,h=l(u-x);return{labourSubtotal:i,materialsSubtotal:c,subtotal:d,vatAmount:m,invoiceTotal:u,cisDeduction:x,netPayment:h,grandTotal:u}}function r(e){return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(e)}a.d(t,{IG:function(){return s},xG:function(){return r}})}},function(e){e.O(0,[448,496,818,282,249,392,231,558,971,23,744],function(){return e(e.s=8358)}),_N_E=e.O()}]);