(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[938,881],{5141:function(e,t,a){Promise.resolve().then(a.bind(a,8972))},8972:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return d}});var r=a(7437),s=a(2265),n=a(6881),o=a(6463),c=a(6079),l=a(4407),i=a(9839),u=a(5188);function d(){let[e,t]=(0,s.useState)(null),[a,d]=(0,s.useState)(!0),[m,p]=(0,s.useState)(!1),[f,b]=(0,s.useState)(null),[x,h]=(0,s.useState)(!1),[y,g]=(0,s.useState)(!1),[v,w]=(0,s.useState)("45.00"),[N,j]=(0,s.useState)(!1),[I,S]=(0,s.useState)(!1),[k,P]=(0,s.useState)(""),[C,A]=(0,s.useState)(""),[_,T]=(0,s.useState)(""),[R,D]=(0,s.useState)(""),[O,E]=(0,s.useState)("free"),[F,U]=(0,s.useState)(!1),[V,X]=(0,s.useState)(!1),[L,B]=(0,s.useState)(null),[M,q]=(0,s.useState)(null),[Z,G]=(0,s.useState)(!1),J=(0,o.useRouter)(),Y=(0,n.createBrowserClient)();(0,s.useEffect)(()=>{H()},[]);let z=async()=>{if((0,i.Pj)())try{var e,t;let a=await (0,i.O3)();if(!a)return;let{entitlements:r}=a,s=(null==r?void 0:r.active)||{},n="expired",o=null,c=!1;if(null===(e=s.trade)||void 0===e?void 0:e.isActive){let e=s.trade;n="TRIAL"===e.periodType||"INTRO"===e.periodType?"trialing":"active",o=e.expirationDate,c=e.willRenew}else if(null===(t=s.pro)||void 0===t?void 0:t.isActive){let e=s.pro;n="TRIAL"===e.periodType||"INTRO"===e.periodType?"trialing":"active",o=e.expirationDate,c=e.willRenew}B(n),q(o),G(c)}catch(e){console.error("Error loading subscription status:",e)}},H=async()=>{try{let{data:{session:e}}=await Y.auth.getSession();if(!e){J.push("/login");return}t(e.user);let a=await (0,l.Fk)(e.user.id),r=await (0,l.canUseVAT)(e.user.id),s=await (0,l.canUseCIS)(e.user.id);E(a),U(r),X(s),await z();let{data:n,error:o}=await Y.from("user_preferences").select("*").eq("user_id",e.user.id).single();o&&"PGRST116"!==o.code&&console.error("Error loading preferences:",o),n&&(w(n.default_labour_rate.toString()),j(r&&n.default_vat_enabled),S(s&&n.default_cis_enabled),P(n.bank_account_name||""),A(n.bank_sort_code||""),T(n.bank_account_number||""),D(n.payment_reference||""))}catch(e){console.error("Error:",e)}finally{d(!1)}},K=async()=>{if(e){p(!0),b(null),h(!1);try{if(C&&!/^\d{2}-\d{2}-\d{2}$/.test(C))throw Error("Sort code must be in format XX-XX-XX");let t=N,a=I,r="";N&&!F&&(t=!1,r="VAT features require Pro plan"),I&&!V&&(a=!1,r=r?r+". CIS features require Trade plan":"CIS features require Trade plan");let s={default_labour_rate:parseFloat(v),default_vat_enabled:t,default_cis_enabled:a,bank_account_name:k||null,bank_sort_code:C||null,bank_account_number:_||null,payment_reference:R||null},{error:n}=await Y.from("user_preferences").upsert({user_id:e.id,...s},{onConflict:"user_id"});if(n)throw n;j(t),S(a),r?(b(r),setTimeout(()=>b(null),4e3)):(h(!0),setTimeout(()=>h(!1),3e3))}catch(e){console.error("Save error:",e),b(e.message||"Failed to save preferences")}finally{p(!1)}}},Q=async()=>{if(e){g(!0),b(null),h(!1);try{let e=await (0,i.NS)();if(!e.success){if(e.userCancelled)return;throw Error(e.error||"No purchases found")}if(e.customerInfo&&!(await (0,u.h)(e.customerInfo)).success)throw Error("Restore succeeded but sync failed. Please contact support.");h(!0),setTimeout(async()=>{h(!1),await H()},2e3)}catch(e){console.error("Restore error:",e),b(e.message||"Failed to restore purchases"),setTimeout(()=>b(null),5e3)}finally{g(!1)}}},$=async()=>{await Y.auth.signOut(),J.push("/login")};return a?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,r.jsx)("span",{className:"font-mono text-sm text-yapmate-slate-300",children:"/ / LOADING SETTINGS"})}),(0,r.jsx)(c.Z,{})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("main",{className:"min-h-screen bg-yapmate-black",children:[(0,r.jsx)("div",{className:"border-b border-yapmate-slate-700 px-4 py-4",children:(0,r.jsx)("h1",{className:"font-mono text-xl font-bold text-yapmate-white uppercase tracking-wide",children:"Settings"})}),f&&(0,r.jsx)("div",{className:"mx-4 mt-4 border-2 border-yapmate-status-red bg-yapmate-status-red/10 p-4",children:(0,r.jsx)("p",{className:"text-yapmate-status-red text-sm font-mono",children:f})}),x&&(0,r.jsx)("div",{className:"mx-4 mt-4 border-2 border-yapmate-status-green bg-yapmate-status-green/10 p-4",children:(0,r.jsx)("p",{className:"text-yapmate-status-green text-sm font-mono",children:"Preferences saved"})}),(0,r.jsxs)("div",{className:"p-4 space-y-6 pb-32",children:[(0,r.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-6",children:[(0,r.jsx)("label",{className:"block text-yapmate-white text-xs font-mono uppercase tracking-wide mb-2",children:"Default Labour Rate (\xa3/hr)"}),(0,r.jsx)("input",{type:"number",step:"0.01",min:"0",value:v,onChange:e=>w(e.target.value),className:"w-full px-4 py-4 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white text-2xl font-mono font-bold focus:outline-none focus:border-yapmate-amber transition-colors duration-snap"}),(0,r.jsx)("p",{className:"text-xs text-yapmate-slate-300 mt-2 font-mono",children:"Used as default for new invoices"})]}),(0,r.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-6",children:[(0,r.jsxs)("label",{className:"flex items-center justify-between ".concat(F?"cursor-pointer":"cursor-not-allowed opacity-50"),children:[(0,r.jsx)("span",{className:"text-yapmate-white text-xs font-mono uppercase tracking-wide",children:"Default VAT Enabled"}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("input",{type:"checkbox",checked:N,onChange:e=>j(e.target.checked),disabled:!F,className:"sr-only peer"}),(0,r.jsx)("div",{className:"w-14 h-8 border-2 border-yapmate-slate-700 peer-focus:border-yapmate-amber peer-checked:bg-yapmate-amber peer-checked:border-yapmate-amber peer-disabled:opacity-50 transition-colors duration-snap"}),(0,r.jsx)("div",{className:"absolute left-1 top-1 w-6 h-6 bg-yapmate-white peer-checked:translate-x-6 transition-transform duration-snap"})]})]}),(0,r.jsx)("p",{className:"text-xs text-yapmate-slate-300 mt-2 font-mono",children:F?"New invoices start with VAT ".concat(N?"ON":"OFF"):"Pro plan required"})]}),(0,r.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-6",children:[(0,r.jsxs)("label",{className:"flex items-center justify-between ".concat(V?"cursor-pointer":"cursor-not-allowed opacity-50"),children:[(0,r.jsx)("span",{className:"text-yapmate-white text-xs font-mono uppercase tracking-wide",children:"Default CIS Enabled"}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("input",{type:"checkbox",checked:I,onChange:e=>S(e.target.checked),disabled:!V,className:"sr-only peer"}),(0,r.jsx)("div",{className:"w-14 h-8 border-2 border-yapmate-slate-700 peer-focus:border-yapmate-amber peer-checked:bg-yapmate-amber peer-checked:border-yapmate-amber peer-disabled:opacity-50 transition-colors duration-snap"}),(0,r.jsx)("div",{className:"absolute left-1 top-1 w-6 h-6 bg-yapmate-white peer-checked:translate-x-6 transition-transform duration-snap"})]})]}),(0,r.jsx)("p",{className:"text-xs text-yapmate-slate-300 mt-2 font-mono",children:V?"New invoices start with CIS ".concat(I?"ON":"OFF"):"Trade plan required"})]}),(0,r.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-6",children:[(0,r.jsx)("h2",{className:"text-yapmate-white text-sm font-mono uppercase tracking-wide mb-4",children:"Payment Details"}),(0,r.jsx)("p",{className:"text-xs text-yapmate-slate-400 font-mono mb-4",children:"Bank details will appear on all generated invoice PDFs"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono uppercase mb-2",children:"Account Name"}),(0,r.jsx)("input",{type:"text",value:k,onChange:e=>P(e.target.value),className:"w-full px-4 py-3 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white font-mono focus:outline-none focus:border-yapmate-amber transition-colors duration-snap",placeholder:"John Smith"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono uppercase mb-2",children:"Sort Code"}),(0,r.jsx)("input",{type:"text",value:C,onChange:e=>A(e.target.value),className:"w-full px-4 py-3 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white font-mono focus:outline-none focus:border-yapmate-amber transition-colors duration-snap",placeholder:"12-34-56",maxLength:8}),(0,r.jsx)("p",{className:"text-xs text-yapmate-slate-400 font-mono mt-1",children:"Format: XX-XX-XX"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono uppercase mb-2",children:"Account Number"}),(0,r.jsx)("input",{type:"text",value:_,onChange:e=>T(e.target.value),className:"w-full px-4 py-3 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white font-mono focus:outline-none focus:border-yapmate-amber transition-colors duration-snap",placeholder:"12345678",maxLength:8})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-yapmate-slate-300 text-xs font-mono uppercase mb-2",children:"Payment Reference (Optional)"}),(0,r.jsx)("input",{type:"text",value:R,onChange:e=>D(e.target.value),className:"w-full px-4 py-3 bg-yapmate-black border-2 border-yapmate-slate-700 text-yapmate-white font-mono focus:outline-none focus:border-yapmate-amber transition-colors duration-snap",placeholder:"e.g. INV or your name"}),(0,r.jsx)("p",{className:"text-xs text-yapmate-slate-400 font-mono mt-1",children:"Defaults to invoice number if left blank"})]})]})]}),(0,i.Pj)()&&(0,r.jsxs)("div",{className:"border-b border-yapmate-slate-700 pb-6",children:[(0,r.jsx)("h2",{className:"text-yapmate-white text-sm font-mono uppercase tracking-wide mb-4",children:"Subscription Management"}),(0,r.jsxs)("div",{className:"mb-4 p-4 bg-yapmate-slate-900 border border-yapmate-slate-700",children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,r.jsx)("span",{className:"text-xs font-mono uppercase text-yapmate-slate-300",children:"Current Plan"}),(0,r.jsx)("span",{className:"text-sm font-mono font-bold text-yapmate-white uppercase",children:O})]}),L&&"expired"!==L&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,r.jsx)("span",{className:"text-xs font-mono uppercase text-yapmate-slate-300",children:"Status"}),(0,r.jsx)("span",{className:"text-sm font-mono font-bold uppercase ".concat("active"===L?"text-yapmate-status-green":"trialing"===L?"text-yapmate-amber":"text-yapmate-slate-400"),children:"trialing"===L?"Free Trial":L})]}),M&&(0,r.jsxs)("div",{className:"flex justify-between items-start",children:[(0,r.jsx)("span",{className:"text-xs font-mono uppercase text-yapmate-slate-300",children:Z?"Renews":"Expires"}),(0,r.jsx)("span",{className:"text-sm font-mono text-yapmate-white",children:new Date(M).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})})]})]}),(!L||"expired"===L)&&"free"===O&&(0,r.jsx)("p",{className:"text-xs font-mono text-yapmate-slate-400 mt-1",children:"No active subscription"})]}),(0,r.jsx)("button",{onClick:Q,disabled:y,className:"w-full h-12 border-2 border-yapmate-amber text-yapmate-amber font-mono font-bold uppercase tracking-wide bg-transparent transition-colors duration-snap active:bg-yapmate-amber active:text-yapmate-black disabled:opacity-50 disabled:cursor-not-allowed",children:y?"Restoring...":"Restore Purchases"}),(0,r.jsx)("p",{className:"text-xs text-yapmate-slate-400 font-mono mt-2",children:"Restore your subscription from a previous purchase"})]}),(0,r.jsx)("div",{className:"pt-4",children:(0,r.jsx)("button",{onClick:$,className:"w-full h-12 border-2 border-yapmate-status-red text-yapmate-status-red font-mono font-bold uppercase tracking-wide bg-transparent transition-colors duration-snap active:bg-yapmate-status-red active:text-yapmate-black",children:"Log Out"})})]}),(0,r.jsx)("div",{className:"fixed bottom-0 left-0 right-0 pb-safe",style:{bottom:"68px"},children:(0,r.jsx)("button",{onClick:K,disabled:m,className:"bar-button h-14",children:m?"SAVING...":"SAVE PREFERENCES"})})]}),(0,r.jsx)(c.Z,{})]})}},6079:function(e,t,a){"use strict";a.d(t,{Z:function(){return o}});var r=a(7437),s=a(7138),n=a(6463);function o(){let e=(0,n.usePathname)();return(0,r.jsx)("nav",{className:"fixed bottom-0 left-0 right-0 bg-yapmate-black/95 backdrop-blur-lg border-t border-yapmate-slate-800 pb-safe",children:(0,r.jsx)("div",{className:"flex justify-around items-center",style:{height:"68px"},children:[{href:"/record",label:"Record",icon:"\uD83C\uDFA4"},{href:"/dashboard",label:"Invoices",icon:"\uD83D\uDCC4"},{href:"/customers",label:"Customers",icon:"\uD83D\uDC65"},{href:"/settings",label:"Settings",icon:"⚙️"}].map(t=>{let a=e===t.href;return(0,r.jsxs)(s.default,{href:t.href,className:"flex flex-col items-center justify-center flex-1 h-full transition-colors duration-200 tap-highlight ".concat(a?"text-yapmate-amber-500":"text-yapmate-slate-400 active:text-yapmate-slate-200"),children:[(0,r.jsx)("span",{className:"text-2xl mb-1",children:t.icon}),(0,r.jsx)("span",{className:"text-xs font-semibold",children:t.label})]},t.href)})})})}},5188:function(e,t,a){"use strict";a.d(t,{h:function(){return s}});var r=a(4392);async function s(e,t){try{let a=(0,r.createClientComponentClient)(),{data:{session:s}}=await a.auth.getSession();if(!s)return{success:!1,error:"No active session"};let n=await a.functions.invoke("sync-revenuecat",{body:{customerInfo:e,revenuecatCustomerId:t}});if(n.error)return console.error("[IAP Sync] Failed:",n.error),{success:!1,error:n.error.message||"Sync failed"};let o=n.data;return console.log("[IAP Sync] Success:",o),{success:!0,plan:o.plan,status:o.status,expirationDate:o.expirationDate,willRenew:o.willRenew}}catch(e){return console.error("[IAP Sync] Error:",e),{success:!1,error:e.message||"Sync failed"}}}},9839:function(e,t,a){"use strict";a.d(t,{Hu:function(){return i},NS:function(){return u},O3:function(){return d},Pj:function(){return o},TQ:function(){return s},nG:function(){return c},si:function(){return l}});var r=a(7185);let s={PRO_MONTHLY:"com.yapmate.pro.monthly",TRADE_MONTHLY:"com.yapmate.trade.monthly"},n=!1;function o(){return"ios"===r.dV.getPlatform()}async function c(e,t){if(!o()){console.log("[IAP] Not available on web, skipping configuration");return}if(n){console.log("[IAP] Already configured, skipping");return}try{let{Purchases:r}=await a.e(586).then(a.bind(a,1938));await r.configure({apiKey:e,appUserID:t||void 0}),n=!0,console.log("[IAP] RevenueCat configured successfully",{appUserID:t})}catch(e){throw console.error("[IAP] Configuration failed:",e),Error("IAP configuration failed: ".concat(e.message))}}async function l(){if(!o())return console.warn("[IAP] getOfferings called on web - returning empty array"),[];if(!n)return console.error("[IAP] SDK not configured - call configureIAP first"),[];try{let{Purchases:e}=await a.e(586).then(a.bind(a,1938)),t=await e.getOfferings();if(!t.current)return console.warn("[IAP] No current offering found"),[];let r=[t.current,...Object.values(t.all)];return console.log("[IAP] Loaded offerings:",r.length),r}catch(e){return console.error("[IAP] Failed to get offerings:",e),[]}}async function i(e){if(!o())return{success:!1,error:"In-app purchases are only available on iOS. Please use the mobile app."};if(!n)return{success:!1,error:"IAP not configured"};try{let{Purchases:r}=await a.e(586).then(a.bind(a,1938));console.log("[IAP] Starting purchase by product ID:",e);let s=await r.getOfferings(),n=[s.current,...Object.values(s.all||{})].filter(Boolean),o=null;for(let a of n){if(null==a?void 0:a.availablePackages)for(let r of a.availablePackages){var t;if((null===(t=r.product)||void 0===t?void 0:t.identifier)===e){o=r.product;break}}if(o)break}if(!o)return{success:!1,error:"Product not found in available offerings"};let c=await r.purchaseStoreProduct({product:o});return console.log("[IAP] Purchase successful"),{success:!0,customerInfo:c.customerInfo}}catch(e){if(console.error("[IAP] Purchase failed:",e),"USER_CANCELLED"===e.code||e.userCancelled)return{success:!1,error:"Purchase cancelled",userCancelled:!0};return{success:!1,error:e.message||"Purchase failed"}}}async function u(){if(!o())return{success:!1,error:"In-app purchases are only available on iOS. Please use the mobile app."};if(!n)return{success:!1,error:"IAP not configured"};try{let{Purchases:e}=await a.e(586).then(a.bind(a,1938));console.log("[IAP] Restoring purchases...");let t=await e.restorePurchases();return console.log("[IAP] Restore successful"),{success:!0,customerInfo:t.customerInfo}}catch(e){return console.error("[IAP] Restore failed:",e),{success:!1,error:e.message||"Failed to restore purchases"}}}async function d(){if(!o())return console.warn("[IAP] getCustomerInfo called on web"),null;if(!n)return console.error("[IAP] SDK not configured"),null;try{let{Purchases:e}=await a.e(586).then(a.bind(a,1938));return(await e.getCustomerInfo()).customerInfo}catch(e){return console.error("[IAP] Failed to get customer info:",e),null}}},4407:function(e,t,a){"use strict";a.d(t,{De:function(){return c},Fk:function(){return n},Nt:function(){return u},canUseCIS:function(){return i},canUseVAT:function(){return l}});var r=a(6881);let s={free:{maxInvoices:3,canUseVAT:!1,canUseCIS:!1},pro:{maxInvoices:null,canUseVAT:!0,canUseCIS:!1},trade:{maxInvoices:null,canUseVAT:!0,canUseCIS:!0}};async function n(e){let t=(0,r.createBrowserClient)(),{data:a,error:s}=await t.from("user_preferences").select("plan").eq("user_id",e).single();return s||!a?(console.warn("Failed to fetch user plan, defaulting to free:",s),"free"):a.plan}async function o(e){let t=(0,r.createBrowserClient)(),{count:a,error:s}=await t.from("invoices").select("*",{count:"exact",head:!0}).eq("user_id",e);return s?(console.error("Failed to fetch invoice count:",s),0):a||0}async function c(e){let t=s[await n(e)];if(null===t.maxInvoices)return{canCreate:!0};let a=await o(e);return a>=t.maxInvoices?{canCreate:!1,reason:"You've reached the limit of ".concat(t.maxInvoices," invoices on the free plan"),currentCount:a,limit:t.maxInvoices}:{canCreate:!0,currentCount:a,limit:t.maxInvoices}}async function l(e){return s[await n(e)].canUseVAT}async function i(e){return s[await n(e)].canUseCIS}function u(e){return({free:"Free",pro:"Pro",trade:"Trade"})[e]}},6881:function(e,t,a){"use strict";a.d(t,{O:function(){return o},createBrowserClient:function(){return l}});var r=a(7204);a(4392);let s="https://nidijdprgoauwkmuioer.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZGlqZHByZ29hdXdrbXVpb2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMDc4NzcsImV4cCI6MjA4MDc4Mzg3N30.kpCiLgYxayUlUOPM0Uip1QsT5wnBpj7gv8yLKOB0vDY";if(!s||!n)throw Error("Missing Supabase environment variables");let o=(0,r.eI)(s,n),c=null;function l(){return c||(c=(0,r.eI)(s,n))}},7138:function(e,t,a){"use strict";a.d(t,{default:function(){return s.a}});var r=a(231),s=a.n(r)},6463:function(e,t,a){"use strict";var r=a(1169);a.o(r,"usePathname")&&a.d(t,{usePathname:function(){return r.usePathname}}),a.o(r,"useRouter")&&a.d(t,{useRouter:function(){return r.useRouter}}),a.o(r,"useSearchParams")&&a.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[392,231,790,971,23,744],function(){return e(e.s=5141)}),_N_E=e.O()}]);