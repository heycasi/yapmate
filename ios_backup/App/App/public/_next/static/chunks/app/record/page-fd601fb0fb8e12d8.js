(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[91],{77:function(e,n,t){Promise.resolve().then(t.bind(t,6464))},6464:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return d}});var a=t(7437),r=t(2265),s=t(6463),o=t(6881),i=t(6079),l=t(3699);let c=t(357).env.NEXT_PUBLIC_OPENAI_API_KEY;c||console.warn("Missing NEXT_PUBLIC_OPENAI_API_KEY environment variable. AI features will fail.");let u=new l.ZP({apiKey:c||"dummy-key",dangerouslyAllowBrowser:!0});function d(){let[e,n]=(0,r.useState)("Plumber"),[t,l]=(0,r.useState)(!1),[c,d]=(0,r.useState)(0),[m,p]=(0,r.useState)(null),[h,b]=(0,r.useState)(null),[f,y]=(0,r.useState)(null),[g,x]=(0,r.useState)(null),[N,v]=(0,r.useState)(!1),[I,w]=(0,r.useState)(!1),[S,j]=(0,r.useState)(null),[T,E]=(0,r.useState)(0),A=(0,s.useRouter)(),C=(0,r.useRef)(null),R=(0,r.useRef)([]),O=(0,r.useRef)(null),k=(0,r.useRef)(null),D=(0,r.useRef)(null),V=(0,r.useRef)(null);(0,r.useEffect)(()=>(U(),()=>{O.current&&clearInterval(O.current)}),[]);let U=async()=>{let{data:{session:e}}=await o.OQ.auth.getSession();e||A.push("/login")},L=async()=>{try{j(null),p(null),b(null),y(null),x(null),d(0),R.current=[];let e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:44100}}),n="audio/webm";MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?n="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?n="audio/ogg;codecs=opus":MediaRecorder.isTypeSupported("audio/mp4")&&(n="audio/mp4"),console.log("Using MIME type:",n);let t=new AudioContext;k.current=t;let a=t.createAnalyser();D.current=a,t.createMediaStreamSource(e).connect(a),a.fftSize=256;let r=new Uint8Array(a.frequencyBinCount),s=()=>{a.getByteFrequencyData(r);let e=r.reduce((e,n)=>e+n)/r.length;E(Math.round(e)),V.current=requestAnimationFrame(s)};s();let o=new MediaRecorder(e,{mimeType:n});C.current=o,o.ondataavailable=e=>{e.data.size>0&&(R.current.push(e.data),console.log("Chunk size:",e.data.size))},o.onstop=async()=>{e.getTracks().forEach(e=>e.stop()),console.log("Audio chunks:",R.current.length,"Total size:",R.current.reduce((e,n)=>e+n.size,0));let t=new Blob(R.current,{type:n});console.log("Final blob size:",t.size,"type:",t.type),await P(t)},o.start(100),l(!0),O.current=setInterval(()=>{d(e=>{let n=e+1;return n>=60?(M(),60):n})},1e3)}catch(e){console.error("Error starting recording:",e),j("Failed to access microphone. Please grant permission and try again.")}},M=()=>{C.current&&t&&(C.current.stop(),l(!1),E(0),O.current&&(clearInterval(O.current),O.current=null),V.current&&(cancelAnimationFrame(V.current),V.current=null),k.current&&(k.current.close(),k.current=null))},P=async e=>{v(!0),j(null);try{var n,t,a;let r=new File([e],"recording.webm",{type:e.type}),s=(await u.audio.transcriptions.create({model:"whisper-1",file:r,language:"en",temperature:0,prompt:"You are transcribing voice notes from UK tradespeople. Speech may include Glaswegian, Edinburgh, Geordie, Scouse, Mancunian and general Scottish/English dialects. Preserve names accurately. Pay special attention to common Scottish surnames such as: Dahl, McDonald, McDowell, Campbell, Robertson, O'Neill, Brown, Smith, Fraser. If the audio sounds like any of these names, prefer the exact spelled version rather than sounding alike alternatives such as Dow or Doll.\n\nExamples:\n- 'Conor Dahl' → Conor Dahl\n- 'Job for Mrs Dahl' → Mrs Dahl\n\nDialect glossary:\n- aye → yes\n- naw / nae → no\n- mibby → maybe\n- an hoor / an hour → one hour\n- a couple of hoors → two hours\n- hunner → one hundred\n- quid → GBP\n\nFocus on accurately capturing:\n- customer names\n- addresses\n- hours / labour time\n- material descriptions and costs\n- CIS / VAT statements\n\nReturn only the exact transcript text with no interpretation."})).text;b(s);let o=await u.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:'You convert UK tradesperson speech with Scottish and Northern English dialects into clean written English.\n\nCRITICAL RULES - YOU MUST NOT CHANGE:\n- Person names (e.g., "Mrs Smith", "John Dahl", "Campbell")\n- Company names (e.g., "Oak Tree Builders", "Acme Plumbing")\n- Street/road names and house numbers (e.g., "24 Oak Street", "15 High Road")\n- Postcodes (e.g., "G12 8QQ", "NE1 4ST")\n- Money amounts (e.g., "\xa3180", "45 quid", "a hundred and twenty pounds")\n- Hour counts (e.g., "3 hours", "an hour and a half")\n\nYOU MAY NORMALISE:\n- Slang: "aye" → "yes", "naw/nae" → "no", "mibby" → "maybe", "an hoor" → "an hour", "hunner" → "hundred", "quid" → "pounds"\n- Filler words: "like", "ken", "ye know", "innit", "um", "uh", "er"\n- Casual grammar: "I done" → "I did", "we was" → "we were"\n\nYOU MUST REMOVE:\n- Garbage tokens that are NOT valid English words AND NOT numbers, currency, postcodes, names, or addresses\n- Examples of garbage to remove: random consonant clusters, transcription artifacts, nonsense syllables\n- ONLY remove if you are certain it is garbage - when in doubt, keep it\n\nCRITICAL: CIS AND VAT PHRASE NORMALISATION\n\nCIS phrases - normalise to clear statements:\n- "aye it\'s CIS", "it\'s a CIS job", "CIS is on", "aye CIS", "CIS applies" → "This is a CIS job."\n- "naw/no CIS", "no CIS on it", "not a CIS job" → "This is not a CIS job."\n\nVAT phrases - normalise to clear statements:\n- "I\'m VAT registered", "plus VAT", "VAT to be added", "VAT is charged" → "VAT is charged."\n- "naw/no VAT", "nae VAT", "no VAT on it", "others nae VAT", "no VAT to add", "VAT not applicable" → "No VAT is charged."\n\nIf both CIS and VAT are mentioned in one messy sentence, split them into two clear sentences.\n\nPRESERVE ALL FACTUAL CONTENT. Output only the cleaned transcript with no preamble.'},{role:"user",content:s}],temperature:0}),i=(null===(a=o.choices[0])||void 0===a?void 0:null===(t=a.message)||void 0===t?void 0:null===(n=t.content)||void 0===n?void 0:n.trim())||s;p(i),await Y(i)}catch(e){console.error("Transcription error:",e),j(e.message||"Failed to transcribe audio")}finally{v(!1)}},Y=async n=>{w(!0),j(null);try{var t,a;let{data:{user:r}}=await o.OQ.auth.getUser();if(!r)throw Error("Not authenticated");let s=e?"\n\nUser's trade: ".concat(e):"",i=await u.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:'You extract clean, structured invoice data from voice transcripts from UK tradespeople.\n\nThe user\'s trade will be provided to help you understand vocabulary and context. Use it ONLY for interpretation guidance - do NOT invent job details based on trade stereotypes.\n\nTRADE VOCABULARY HINTS:\n- Plumber: radiator, valve, boiler, pipe, trap, leak, washer, ballcock, cistern, copper, flux, solder\n- Electrician: socket, switch, fuse, consumer unit, spur, rewire, cable, patress, backbox, breaker, rcd\n- Joiner: skirting, architrave, stud, ply, mdf, hinge, lock, door, frame, joist, batten\n- Painter & Decorator: emulsion, gloss, undercoat, primer, filler, caulk, masking, roller, cutting in\n- Other: Use general trade context\n\nYou must output JSON that matches this EXACT TypeScript type:\n\nInvoice {\n  customerName: string | null;\n  jobSummary: string; // REQUIRED: Never null\n  labourHours: number | null;\n  materials: { description: string; cost: number | null }[];\n  cisJob: boolean | null; // true/false if mentioned, null if unknown\n  vatRegistered: boolean | null; // true/false if mentioned, null if unknown\n  notes: string | null;\n}\n\nCORE RULE (NON-NEGOTIABLE):\nIf you are unsure about a value, return null. NEVER guess.\n\nFIELD RULES\n\n1) customerName\n- Extract EXACTLY as spoken in the transcript. Do NOT correct spelling.\n- Look for phrases like: "job for Mrs Smith", "for John Campbell", "invoice for Acme Ltd"\n- Strip leading filler ("job for", "work for", "invoice for").\n- CRITICAL: Preserve names exactly - if transcript says "Dahl", use "Dahl" (not "Dow" or "Doll")\n- If no customer name mentioned → null\n- If confidence is low (e.g., unclear audio, multiple names) → null\n\n2) jobSummary\n- One short sentence (max 35 words) that sums up the work done.\n- Use trade-friendly wording.\n- Do NOT include prices, hours, addresses or payment terms here.\n- Examples:\n  - "Replaced leaking radiator valve and fitted new radiator in living room."\n  - "Serviced boiler and replaced faulty pump."\n\n3) labourHours\n- Extract ONLY if explicitly stated with a clear number.\n- Supported UK phrasing:\n  - "an hour" / "an hoor" → 1\n  - "hour and a half" / "hoor and a half" → 1.5\n  - "couple of hours" / "couple of hoors" → 2\n  - "half an hour" / "half an hoor" → 0.5\n  - "two and a half hours" → 2.5\n  - "three hours" → 3\n- VAGUE phrases return null:\n  - "wee while" → null\n  - "most of the afternoon" → null\n  - "quick job" → null\n  - "bit of time" → null\n- If no time mentioned → null\n\n4) materials\n- Each clearly separate part or material becomes one item.\n- description:\n  - Short, specific phrase:\n    - "600mm double radiator"\n    - "boiler valve kit"\n    - "copper pipe and fittings"\n  - Keep the description as stated (preserve terminology).\n- cost:\n  - ONLY extract if explicitly stated. NO guessing.\n  - Supported UK money slang:\n    - "quid" → pounds (e.g., "180 quid" → 180)\n    - "hunner" → 100 (e.g., "a hunner and eighty quid" → 180)\n    - "one fifty" → 150\n    - "a hundred and twenty" → 120\n  - Return numeric value only (no \xa3 symbol).\n  - If material mentioned with no price → cost: null\n  - If no materials mentioned → []\n\n5) cisJob (CRITICAL: Never guess)\n- Return true ONLY if transcript contains explicit CIS confirmation:\n  - "This is a CIS job"\n  - "aye it\'s CIS"\n  - "CIS applies"\n  - "CIS job"\n  - "CIS is on"\n- Return false ONLY if transcript explicitly says NO to CIS:\n  - "This is not a CIS job"\n  - "no CIS"\n  - "naw CIS"\n  - "not a CIS job"\n- Return null if CIS is NOT mentioned at all\n\n6) vatRegistered (CRITICAL: Never guess)\n- Return true ONLY if transcript contains explicit VAT confirmation:\n  - "VAT is charged"\n  - "I\'m VAT registered"\n  - "plus VAT"\n  - "VAT to be added"\n- Return false ONLY if transcript explicitly says NO to VAT:\n  - "No VAT is charged"\n  - "no VAT"\n  - "naw VAT"\n  - "nae VAT"\n  - "not VAT registered"\n- Return null if VAT is NOT mentioned at all\n\n7) notes\n- Short free-text field for any extra useful info that does not fit above:\n  - payment terms: "payment due in 14 days"\n  - address: "24 Oak Street, Glasgow"\n  - extra context: "tenant will pay materials separately"\n- Do NOT repeat the full job summary.\n- If there is nothing useful to add → null.\n\nAlways respond with ONLY the JSON object and nothing else.'},{role:"user",content:"Extract invoice data from this transcript:".concat(s,"\n\nTranscript:\n").concat(n)}],temperature:0,response_format:{type:"json_object"}}),l=null===(a=i.choices[0])||void 0===a?void 0:null===(t=a.message)||void 0===t?void 0:t.content;if(!l)throw Error("No AI response");let c=JSON.parse(l),{data:d,error:m}=await o.OQ.from("invoices").insert({user_id:r.id,customer_name:c.customerName,job_summary:c.jobSummary,labour_hours:c.labourHours,labour_rate:45,cis_job:c.cisJob,cis_rate:20,vat_registered:c.vatRegistered,vat_rate:20,status:"draft",notes:c.notes}).select().single();if(m)throw m;if(!d)throw Error("Failed to create invoice record");if(c.materials.length>0){let e=c.materials.filter(e=>null!==e.cost).map(e=>({invoice_id:d.id,description:e.description,cost:e.cost,quantity:1}));e.length>0&&await o.OQ.from("materials").insert(e)}y(c),x(d.id)}catch(e){console.error("Extraction error:",e),j(e.message||"Failed to extract invoice data")}finally{w(!1)}},{mins:_,secs:F}={mins:Math.floor(c/60),secs:c%60},J=t&&F%2==0;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"w-full h-12 flex items-center justify-center border-b transition-colors duration-snap ".concat(t?"bg-yapmate-status-red border-yapmate-status-red":"bg-yapmate-black border-yapmate-slate-700 dark:border-yapmate-slate-700"),style:t?void 0:{backgroundImage:"repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(51, 65, 85, 0.3) 10px, rgba(51, 65, 85, 0.3) 20px)"},children:(0,a.jsx)("span",{className:"section-header border-0 py-0",children:t?"/ / RECORDING IN PROGRESS":N?"/ / PROCESSING AUDIO":I?"/ / EXTRACTING DATA":"/ / SYSTEM READY"})}),(0,a.jsxs)("main",{className:"min-h-screen flex flex-col",children:[(0,a.jsxs)("div",{className:"data-row",children:[(0,a.jsx)("span",{className:"data-label",children:"TRADE"}),(0,a.jsxs)("select",{value:e,onChange:e=>n(e.target.value),disabled:t||N||I,className:"bg-transparent border-none text-white font-mono text-sm uppercase focus:outline-none disabled:opacity-50",children:[(0,a.jsx)("option",{value:"Plumber",children:"PLUMBER"}),(0,a.jsx)("option",{value:"Electrician",children:"ELECTRICIAN"}),(0,a.jsx)("option",{value:"Joiner",children:"JOINER"}),(0,a.jsx)("option",{value:"Painter & Decorator",children:"PAINTER"}),(0,a.jsx)("option",{value:"Other",children:"OTHER"})]})]}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center px-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-center mb-12",children:[(0,a.jsx)("span",{className:"text-8xl font-mono font-bold tabular-nums",children:_.toString().padStart(2,"0")}),(0,a.jsx)("span",{className:"text-8xl font-mono font-bold mx-2 transition-opacity duration-0 ".concat(J?"opacity-0":"opacity-100"),children:":"}),(0,a.jsx)("span",{className:"text-8xl font-mono font-bold tabular-nums",children:F.toString().padStart(2,"0")})]}),t&&(0,a.jsxs)("div",{className:"w-full max-w-md mb-8",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsx)("span",{className:"data-label",children:"INPUT LEVEL"}),(0,a.jsxs)("span",{className:"font-mono text-sm",children:[T," dB"]})]}),(0,a.jsx)("div",{className:"w-full h-3 border border-yapmate-slate-700 dark:border-yapmate-slate-700",children:(0,a.jsx)("div",{className:"h-full bg-yapmate-status-green transition-none",style:{width:"".concat(Math.min(100,T/128*100),"%")}})})]}),t?(0,a.jsx)("button",{onClick:M,className:"w-32 h-32 bg-yapmate-slate-900 flex items-center justify-center transition-transform duration-0 active:scale-98 border-2 border-yapmate-slate-700",style:{transform:"scale(1)"},children:(0,a.jsx)("div",{className:"w-12 h-12 bg-yapmate-white"})}):(0,a.jsx)("button",{onClick:L,disabled:N||I,className:"w-32 h-32 bg-yapmate-status-red disabled:bg-yapmate-slate-700 disabled:cursor-not-allowed flex items-center justify-center transition-transform duration-0 active:scale-98 border-2 border-yapmate-black dark:border-yapmate-black",style:{transform:"scale(1)"},children:(0,a.jsx)("div",{className:"w-12 h-12 bg-yapmate-white"})})]}),S&&(0,a.jsxs)("div",{className:"w-full bg-yapmate-status-red border-y border-yapmate-black py-3 px-4",children:[(0,a.jsx)("span",{className:"data-label text-yapmate-black",children:"ERROR"}),(0,a.jsx)("p",{className:"text-yapmate-black font-mono text-sm mt-1",children:S})]}),m&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"section-header",children:"// TRANSCRIPT"}),(0,a.jsx)("div",{className:"px-4 py-4 border-b border-yapmate-slate-700 dark:border-yapmate-slate-700",children:(0,a.jsx)("p",{className:"font-mono text-sm leading-relaxed",children:m})})]}),f&&g&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"section-header",children:"// INVOICE CREATED"}),(0,a.jsxs)("div",{className:"data-row",children:[(0,a.jsx)("span",{className:"data-label",children:"STATUS"}),(0,a.jsx)("span",{className:"status-badge text-yapmate-status-green",children:"READY"})]}),(0,a.jsxs)("div",{className:"data-row",children:[(0,a.jsx)("span",{className:"data-label",children:"CUSTOMER"}),(0,a.jsx)("span",{className:"data-value mono text-base",children:f.customerName||"UNSPECIFIED"})]}),(0,a.jsxs)("div",{className:"data-row border-b-0",children:[(0,a.jsx)("span",{className:"data-label",children:"JOB"}),(0,a.jsx)("span",{className:"font-mono text-sm text-right max-w-[60%]",children:f.jobSummary})]})]}),f&&g&&(0,a.jsx)("div",{className:"fixed bottom-0 left-0 right-0 pb-safe",children:(0,a.jsx)("button",{onClick:()=>A.push("/invoice?id=".concat(g)),className:"bar-button h-14",children:"REVIEW INVOICE"})}),(0,a.jsx)("div",{className:"h-20"})]}),(0,a.jsx)(i.Z,{})]})}},6079:function(e,n,t){"use strict";t.d(n,{Z:function(){return o}});var a=t(7437),r=t(7138),s=t(6463);function o(){let e=(0,s.usePathname)();return(0,a.jsx)("nav",{className:"fixed bottom-0 left-0 right-0 bg-yapmate-black/95 backdrop-blur-lg border-t border-yapmate-slate-800 pb-safe",children:(0,a.jsx)("div",{className:"flex justify-around items-center",style:{height:"68px"},children:[{href:"/dashboard",label:"Home",icon:"\uD83C\uDFE0"},{href:"/record",label:"Record",icon:"\uD83C\uDFA4"},{href:"/customers",label:"Customers",icon:"\uD83D\uDC65"},{href:"/settings",label:"Settings",icon:"⚙️"}].map(n=>{let t=e===n.href;return(0,a.jsxs)(r.default,{href:n.href,className:"flex flex-col items-center justify-center flex-1 h-full transition-colors duration-200 tap-highlight ".concat(t?"text-yapmate-amber-500":"text-yapmate-slate-400 active:text-yapmate-slate-200"),children:[(0,a.jsx)("span",{className:"text-2xl mb-1",children:n.icon}),(0,a.jsx)("span",{className:"text-xs font-semibold",children:n.label})]},n.href)})})})}},6881:function(e,n,t){"use strict";t.d(n,{AY:function(){return l},OQ:function(){return o}});var a=t(2562);t(4392);let r="https://nidijdprgoauwkmuioer.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZGlqZHByZ29hdXdrbXVpb2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMDc4NzcsImV4cCI6MjA4MDc4Mzg3N30.kpCiLgYxayUlUOPM0Uip1QsT5wnBpj7gv8yLKOB0vDY";if(!r||!s)throw Error("Missing Supabase environment variables");let o=(0,a.eI)(r,s),i=null;function l(){return i||(i=(0,a.eI)(r,s))}}},function(e){e.O(0,[231,730,699,971,23,744],function(){return e(e.s=77)}),_N_E=e.O()}]);